<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title>Robot Framework: 擴充現有的 Test Library</title>
<link rel="stylesheet" href="../../_asciidoc/stylesheets/asciidoc.css" type="text/css" />
<link rel="stylesheet" href="../../_asciidoc/stylesheets/layout2.css" type="text/css" />
<link rel="stylesheet" href="../../_asciidoc/stylesheets/pygments.css" type="text/css" />
<link rel="Stylesheet" href="http://www.diigo.com/stylesheets/link_rolls_standard.css" title="style_standard" type="text/css" media="screen" />
<script type="text/javascript" src="../../_asciidoc/javascripts/asciidoc.js"></script>
<script type="text/javascript">
/*<![CDATA[*/
asciidoc.install();
/*]]>*/
</script>
</head>
<body>
<div id="layout-menu-box">
<div id="layout-menu">
  <div><a href="../../index.html">首頁</a> | <a href="http://www.diigo.com/user/imsardine" target="_blank">閱讀</a> | <a href="../../note/index.html">筆記</a></div>
  <div>
    <img src="http://www.gravatar.com/avatar/ca5d67276ca1ff3e5391438d7865ddf2" width="32" style="border:none"/>
    <a href="http://imsardine.wordpress.com/" target="_blank"><img src="http://s.wordpress.org/about/images/logos/wordpress-logo-32-blue.png" style="border:none"/></a>
  </div>
  <iframe src="http://githubbadge.appspot.com/badge/imsardine?s=1" style="border: 0;height: 142px;width: 200px;overflow: hidden;" frameBorder=0></iframe>
</div>
</div>
<div id="layout-content-box">
<div id="layout-banner">
  <div id="layout-title">在電梯裡遇見雙胞胎</div>
  <div id="layout-description">腦袋不是用來裝東西，而是用來思考問題的；所以我把懶得記的、記不住的，通通寫在這裡... <a href="http://www.diigo.com" onclick="var s=document.createElement('script');s.type='text/javascript';s.src='http://www.diigo.com/javascripts/webtoolbar/diigolet_b_h_b.js';document.body.appendChild(s);return false;"><img style="border:none" alt="Add to Diigo" src="http://www.diigo.com/images/diigo-icon/16.png" /></a></div>
</div>
<div id="layout-content">
<div id="header">
<h1>Robot Framework: 擴充現有的 Test Library</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>官方的 <a href="http://robotframework.googlecode.com/hg/doc/userguide/RobotFrameworkUserGuide.html?#extending-existing-test-libraries">User Guide</a> 提到，BuiltIn Library 是擴充現有 test library 最好的方法。下面以擴充 Screenshot Library 為例：</p></div>
<div class="listingblock">
<div class="title"><code>examples/extkw/test.txt</code></div>
<div class="content">
<pre><code>| *Setting* | *Value*
| Library | Screenshot
| Library | MyScreenshotLibrary

| *Test Case* | *Action* | *Argument*
| Test | Take Snapshot | desktop</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="../../_asciidoc/images/icons/caution.png" alt="Caution" />
</td>
<td class="content">雖然沒有直接用到 Screenshot Library，但如果沒有明確引進來的話，執行期會出現 "No library with name 'Screenshot' found." 的錯誤，建議在 test library 的文件上額外做說明。</td>
</tr></table>
</div>
<div class="listingblock">
<div class="title"><code>examples/extkw/MyScreenshotLibrary</code></div>
<div class="content">
<pre><code>from robot.libraries.BuiltIn import BuiltIn

class MyScreenshotLibrary:

  _builtin = BuiltIn()

  @property
  def _screenshot_lib(self):
    return self._builtin.get_library_instance('Screenshot') <img src="../../_asciidoc/images/icons/callouts/1.png" alt="1" />

  def take_snapshot(self, name, width='800px'):
      img = self._screenshot_lib.take_screenshot(name, width) <img src="../../_asciidoc/images/icons/callouts/2.png" alt="2" />
      print '*WARN* snapshot:', img</code></pre>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="../../_asciidoc/images/icons/callouts/1.png" alt="1" /></td><td>
透過 <code>BuiltIn</code> instance 取得其他 library 的 active instance，跟 test library 的 scope 無關。
</td></tr>
<tr><td><img src="../../_asciidoc/images/icons/callouts/2.png" alt="2" /></td><td>
等同在 test data 裡 <code>Screenshot.Take Screenshot</code> 的用法。
</td></tr>
</table></div>
<div class="paragraph"><p>執行結果：</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ pybot -d /tmp test.txt
==============================================================================
Test
==============================================================================
[ WARN ] snapshot: /tmp/desktop_1.jpg
Test                                                                  | PASS |</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="../../_asciidoc/images/icons/tip.png" alt="Tip" />
</td>
<td class="content">
<div class="paragraph"><p>BuiltIn Library 是 global scope，我們手動生成的那個 <code>BuiltIn</code> instance 當然跟 runtime 系統唯一的那個 BuiltIn Library instance 不同，但我們卻可以透過它去取得其他 library instance？</p></div>
<div class="paragraph"><p>那是因為 test library instance 並不是記錄在 BuiltIn Library instance 裡：</p></div>
<div class="listingblock">
<div class="title"><code>libraries/BuiltIn.py</code></div>
<div class="content">
<pre><code>from robot.running import Keyword, NAMESPACES, RUN_KW_REGISTER

class _Misc:

    def get_library_instance(self, name):
        try:
            return self._namespace.get_library_instance(name)
        except DataError, err:
            raise RuntimeError(unicode(err))

class BuiltIn(_Verify, _Converter, _Variables, _RunKeyword, _Misc):
    ROBOT_LIBRARY_SCOPE = 'GLOBAL'

    @property
    def _namespace(self):
        return NAMESPACES.current</code></pre>
</div></div>
<div class="listingblock">
<div class="title"><code>running/__init__.py</code></div>
<div class="content">
<pre><code>class _Namespaces:

# Hook to namespaces
NAMESPACES = _Namespaces() <img src="../../_asciidoc/images/icons/callouts/1.png" alt="1" /></code></pre>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="../../_asciidoc/images/icons/callouts/1.png" alt="1" /></td><td>
原來 <code>NAMESPACES</code> 是個 singleton。
</td></tr>
</table></div>
<div class="paragraph"><p>或許 <code>BuiltIn.get_library_instance()</code> 一開始就被設計成 static/class method 就不會有使用上的疑慮了。</p></div>
<div class="paragraph"><p>如果這是改變不了的事實，建議將 <code>BuiltIn</code> instance 快取起來，這樣取用 test case 或 test suite scope 的 library instance 時，就不用一直生成全新的 <code>BuiltIn</code> instance。</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>下面示範擴充 Selenium Library 的做法：</p></div>
<div class="listingblock">
<div class="title"><code>MySeleniumLibrary.py</code></div>
<div class="content">
<pre><code>class MySeleniumLibrary:

    _builtin = BuiltIn()
    _selenium_lib = None

    @property
    def _screenshot_lib(self):
        return self._builtin.get_library_instance('Screenshot') # test suite scope

    @property
    def _selenium(self):
        if self._selenium_lib is None:
            self._selenium_lib = self._builtin.get_library_instance('SeleniumLibrary')
        return self._selenium_lib._selenium

    def login(self, username, password, language=None, service_hint=None):
        self._selenium.open(...)
        self._screenshot_lib.take_screenshot()</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="../../_asciidoc/images/icons/warning.png" alt="Warning" />
</td>
<td class="content">
<div class="paragraph"><p><code>get_library_instance()</code> 不能在 <code>__init()</code> 裡呼叫，否則 RIDE 和真正跑測試時，會分別出現下面的錯誤：（事實上任何初始化的工作都不應該在 <code>__init__()</code> 裡做）</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AttributeError: 'NoneType' object has no attribute 'get_library_instance'</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>[ ERROR ] Invalid syntax in file 'xxx.txt' in table 'Settings': Creating an instance of the test library 'MyLibrary' with no arguments failed: No library with name 'SeleniumLibrary' found.</code></pre>
</div></div>
<div class="paragraph"><p>顯然我們不能假設 Robot Framework 載入 test libraries 的順序&#8230;</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_參考資料">參考資料</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
<a href="http://robotframework.googlecode.com/hg/doc/userguide/RobotFrameworkUserGuide.html?#extending-existing-test-libraries">User Guide &gt; Extending existing test libraries</a>
</p>
</li>
<li>
<p>
<a href="http://robotframework.googlecode.com/hg/doc/libraries/BuiltIn.html#Get%20Library%20Instance">BuiltIn &gt; Get Library Instance</a>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2012-12-15 20:42:24 CST
</div>
<div id="footer-badges">
<a href="http://validator.w3.org/check?uri=referer">
  <img style="border:0;width:88px;height:31px"
    src="http://www.w3.org/Icons/valid-xhtml11-blue"
    alt="Valid XHTML 1.1" height="31" width="88" />
</a>
<a href="http://jigsaw.w3.org/css-validator/">
  <img style="border:0;width:88px;height:31px"
    src="http://jigsaw.w3.org/css-validator/images/vcss-blue"
    alt="Valid CSS!" />
</a>
</div>
</div>
</div>
</div>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" src="http://s.gravatar.com/js/gprofiles.js?ver=e"></script>
<script>jQuery(document).ready(function($){ Gravatar.init(); });</script>
</body>
</html>
